<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Modules/prepare.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Modules/prepare.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// import dependencies
import { Image } from 'react-native';
import * as SplashScreen from 'expo-splash-screen';
import AsyncStorage from '@react-native-async-storage/async-storage';
import NetInfo from '@react-native-community/netinfo';

/**
 * @function prepare : 
 * Determines data sources and retrives data on app startup
 * @returns {Object|null}
 */
export default async function prepare() {
  // fetch any necessary information from API on startup
  // if not connected, use local data
  // if not connected and no local data, return null
  // Keep the splash screen visisble while we fetch resources
  await SplashScreen.preventAutoHideAsync();
    try {
			// comment this out for production
			// await AsyncStorage.clear();
      // first, test internet connection / simultaneously see if there is any local data
      let state, localVersion, updateData = true;
      try {
        let statePromise = NetInfo.fetch();
        let versionPromise = AsyncStorage.getItem('@version');
        const promiseResults = await Promise.all([statePromise, versionPromise]);
        state = promiseResults[0];
        localVersion = promiseResults[1];
        // if we have neither return null, App to display default 'no data' screen
        if ((!state.isConnected) &amp;&amp; (localVersion === null))
        return null;
      }
      catch (err) {
        return null;
      }
      // if we have a connection, get current version of API data
      if (state.isConnected) {
        const apiVersion = await fetch('https://outertownfest.com/api/version.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then(res=>res.text());
        // if we have the same version locally as on the API or if connection is expensive use local data
        if ((localVersion === apiVersion) || state.details.isConnectionExpensive)
          updateData = false;
        // otherwise update from API, set local version to api version
        else
          AsyncStorage.setItem('@version', apiVersion);
      }
      // prepare some variables for our data
      let venuesData = null, bandsData = null, performancesData = null;
			// check if we have local data saved
      console.log('Retrieving data from local storage...');
      let localVenuesPromise = AsyncStorage.getItem('@venuesData');
      let localBandsPromise = AsyncStorage.getItem('@bandsData');
      let localPerformancesPromise = AsyncStorage.getItem('@performancesData');
      const localData = await Promise.all([localVenuesPromise, localBandsPromise, localPerformancesPromise]);
      let localVenuesData       = localData[0];
      let localBandsData        = localData[1];
      let localPerformancesData = localData[2];
      // if we do then use it
      if (localVenuesData !== null)
      venuesData = JSON.parse(localVenuesData);
      if (localBandsData !== null)
      bandsData = JSON.parse(localBandsData);
      if (localPerformancesData !== null)
      performancesData = JSON.parse(localPerformancesData);
      // Get festival info from API if no local data
      if (venuesData === null || updateData) {
        console.log('Retrieving data from API...');
        venuesData = fetch('https://outertownfest.com/api/venues.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then((res)=>res.json())
				.then((data)=>{
					AsyncStorage.setItem('@venuesData', JSON.stringify(data));
					return data;
				})
      }
      if (bandsData === null || updateData) {
				bandsData = fetch('https://outertownfest.com/api/bands.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then((res)=>res.json())
				.then((data)=>{
					AsyncStorage.setItem('@bandsData', JSON.stringify(data));
					return data;
				})
      }
      if (performancesData === null || updateData) {
				performancesData    = fetch('https://outertownfest.com/api/performances.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then((res)=>res.json())
				.then((data)=>{
          data.map(performance=>performance.Start = new Date(performance.Start.replace(' ', 'T')));
          data.map(performance=>performance.End = new Date(performance.End.replace(' ', 'T')));
          AsyncStorage.setItem('@performancesData', JSON.stringify(data));
					return data;
				})
      }
      const appData = await Promise.all([venuesData, bandsData, performancesData]);
      return appData;
    }
    catch (e) {
      console.warn(e);
      return null;
    }
  }

export async function cacheImages(images) {
    return images.map(image => {
        return Image.prefetch(image);
    })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="paths%2520_%2520%250AURL%2520paths%2520used%2520in%2520other%2520scriptsmodule_.html">paths : 
URL paths used in other scripts</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AllPerformanceHeader:ReactNativecomponentfordisplayinganinformationheaderfortheperformancesmodal">AllPerformanceHeader : 
React Native component for displaying an information header for the performances modal</a></li><li><a href="global.html#AllPerformances:ReactNativecomponentfordisplayingalistofallperformances">AllPerformances : 
React Native component for displaying a list of all performances</a></li><li><a href="global.html#BandInfo:ReactNativecomponentforshowinginformationaboutaband">BandInfo :
React Native component for showing information about a band</a></li><li><a href="global.html#getBandInfo:Retrievebandinfofromlocalstorage">getBandInfo : 
Retrieve band info from local storage</a></li><li><a href="global.html#getBandPerformance:Retrieveperformance(s)byabandfromlocalstorage">getBandPerformance : 
Retrieve performance(s) by a band from local storage</a></li><li><a href="global.html#getLiked:Retrievelikedstatusofbandfromlocalstorage">getLiked : 
Retrieve liked status of band from local storage</a></li><li><a href="global.html#handleLike:Setsupnotificationsandfeedbackonabandlikedbyauser">handleLike : 
Sets up notifications and feedback on a band liked by a user</a></li><li><a href="global.html#handleSwipe:Opensmodalwhenleftscreenswipedetectedhttps://dev.to/nrymarz/creating-a-tinder-style-swiping-component-with-react-native-part-1-2-h45">handleSwipe : 
Opens modal when left screen swipe detected
https://dev.to/nrymarz/creating-a-tinder-style-swiping-component-with-react-native-part-1-2-h45</a></li><li><a href="global.html#HideAllPerformances:ReactNativecomponentfordisplayingabuttontoclosetheperformancesmodal">HideAllPerformances : 
React Native component for displaying a button to close the performances modal</a></li><li><a href="global.html#HomeScreen:ReactNativecomponenttodisplayapplicationhomescreen">HomeScreen : 
React Native component to display application home screen</a></li><li><a href="global.html#ItemLoading:ReactNativecomponentfordisplayinganimatedscreenwhiledataisloadingasynchronously">ItemLoading : 
React Native component for displaying animated screen while data is loading asynchronously</a></li><li><a href="global.html#LinkWrapper:ReactNativecomponentfordisplayingahyperlinkedchilecomponent">LinkWrapper : 
React Native component for displaying a hyperlinked chile component</a></li><li><a href="global.html#Loading:ReactNativecomponentfordisplayinganimatedscreenwhiledataisloadingasynchronously">Loading : 
React Native component for displaying animated screen while data is loading asynchronously</a></li><li><a href="global.html#NoData:ReactNativecomponentfordisplayingcontentwhenthereisnointernetconnectionandnolocallystoreddata">NoData : 
React Native component for displaying content when there is no internet connection and no locally stored data</a></li><li><a href="global.html#OTLogo:ReactNativecomponentfordisplayingfestivallogo">OTLogo : 
React Native component for displaying festival logo</a></li><li><a href="global.html#PageContainer:ReactNativecomponenttoprovideacontainerappropriatetothecurrentpage">PageContainer : 
React Native component to provide a container appropriate to the current page</a></li><li><a href="global.html#parsePerformances:Takesinputjsonstring,parsesitintoobjectforuseincomponents">parsePerformances : 
Takes input json string, parses it into object for use in components</a></li><li><a href="global.html#Performance:ReactNativecomponentfordisplayinginformationaboutaperformance">Performance :
React Native component for displaying information about a performance</a></li><li><a href="global.html#PostShowHome:ReactNativecomponenttodisplaypost-showinformationscreen">PostShowHome : 
React Native component to display post-show information screen</a></li><li><a href="global.html#prepare:Determinesdatasourcesandretrivesdataonappstartup">prepare : 
Determines data sources and retrives data on app startup</a></li><li><a href="global.html#ScreenWrapper:ReactNativecomponentprovidingatemplatewrapperforeachscreen">ScreenWrapper : 
React Native component providing a template wrapper for each screen</a></li><li><a href="global.html#SwipeHeader:ReactNativecomponenttodisplayinformationalscreenheader">SwipeHeader : 
React Native component to display informational screen header</a></li><li><a href="global.html#VenueInfo:ReactNativecomponentfordisplayinginformationaboutavenue">VenueInfo :
React Native component for displaying information about a venue</a></li><li><a href="global.html#VenueList:ReactNativecomponentfordisplayingalistofvenues">VenueList :
React Native component for displaying a list of venues</a></li><li><a href="global.html#VenueTitle:ReactNativecomponentfordisplayingavenuetitleorlogo">VenueTitle :
React Native component for displaying a venue title or logo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Fri Feb 11 2022 13:20:22 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
