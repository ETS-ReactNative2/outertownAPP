<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: prepare.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: prepare.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// import dependencies
import { Image } from 'react-native';
import * as SplashScreen from 'expo-splash-screen';
import AsyncStorage from '@react-native-async-storage/async-storage';
import NetInfo from '@react-native-community/netinfo';

/**
 * @function prepare
 * Determines data sources and retrives data on app startup
 * @returns {Object|null}
 */
const prepare = async () => {
  // fetch any necessary information from API on startup
  // if not connected, use local data
  // if not connected and no local data, return null
  // Keep the splash screen visisble while we fetch resources
  await SplashScreen.preventAutoHideAsync();
    try {
			// comment this out for production
			// await AsyncStorage.clear();
      // first, test internet connection / simultaneously see if there is any local data
      let state, localVersion, updateData = true;
      try {
        let statePromise = NetInfo.fetch();
        let versionPromise = AsyncStorage.getItem('@version');
        const promiseResults = await Promise.all([statePromise, versionPromise]);
        state = promiseResults[0];
        localVersion = promiseResults[1];
        // if we have neither return null, App to display default 'no data' screen
        if ((!state.isConnected) &amp;&amp; (localVersion === null))
        return null;
      }
      catch (err) {
        return null;
      }
      // if we have a connection, get current version of API data
      if (state.isConnected) {
        const apiVersion = await fetch('https://outertownfest.com/api/version.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then(res=>res.text());
        // if we have the same version locally as on the API or if connection is expensive use local data
        if ((localVersion === apiVersion) || state.details.isConnectionExpensive)
          updateData = false;
        // otherwise update from API, set local version to api version
        else
          AsyncStorage.setItem('@version', apiVersion);
      }
      // prepare some variables for our data
      let venuesData = null, bandsData = null, performancesData = null;
			// check if we have local data saved
      console.log('Retrieving data from local storage...');
      let localVenuesPromise = AsyncStorage.getItem('@venuesData');
      let localBandsPromise = AsyncStorage.getItem('@bandsData');
      let localPerformancesPromise = AsyncStorage.getItem('@performancesData');
      const localData = await Promise.all([localVenuesPromise, localBandsPromise, localPerformancesPromise]);
      let localVenuesData       = localData[0];
      let localBandsData        = localData[1];
      let localPerformancesData = localData[2];
      // if we do then use it
      if (localVenuesData !== null)
      venuesData = JSON.parse(localVenuesData);
      if (localBandsData !== null)
      bandsData = JSON.parse(localBandsData);
      if (localPerformancesData !== null)
      performancesData = JSON.parse(localPerformancesData);
      // Get festival info from API if no local data
      if (venuesData === null || updateData) {
        console.log('Retrieving data from API...');
        venuesData = fetch('https://outertownfest.com/api/venues.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then((res)=>res.json())
				.then((data)=>{
					AsyncStorage.setItem('@venuesData', JSON.stringify(data));
					return data;
				})
      }
      if (bandsData === null || updateData) {
				bandsData = fetch('https://outertownfest.com/api/bands.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then((res)=>res.json())
				.then((data)=>{
					AsyncStorage.setItem('@bandsData', JSON.stringify(data));
					return data;
				})
      }
      if (performancesData === null || updateData) {
				performancesData    = fetch('https://outertownfest.com/api/performances.php', {headers: {
          'Content-type': 'application/json',}
        })
        .then((res)=>res.json())
				.then((data)=>{
          data.map(performance=>performance.Start = new Date(performance.Start.replace(' ', 'T')));
          data.map(performance=>performance.End = new Date(performance.End.replace(' ', 'T')));
          AsyncStorage.setItem('@performancesData', JSON.stringify(data));
					return data;
				})
      }
      const appData = await Promise.all([venuesData, bandsData, performancesData]);
      return appData;
    }
    catch (e) {
      console.warn(e);
      return null;
    }
  }

  export default prepare;

  export const cacheImages = async (images) => {
    return images.map(image => {
        return Image.prefetch(image);
    })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="paths%250AURL%2520paths%2520used%2520in%2520other%2520scriptsmodule_.html">paths
URL paths used in other scripts</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getBandInfoRetrievebandinfofromlocalstorage">getBandInfo
Retrieve band info from local storage</a></li><li><a href="global.html#getBandPerformanceRetrieveperformance(s)byabandfromlocalstorage">getBandPerformance
Retrieve performance(s) by a band from local storage</a></li><li><a href="global.html#getLikedRetrievelikedstatusofbandfromlocalstorage">getLiked
Retrieve liked status of band from local storage</a></li><li><a href="global.html#handleLikeSetsupnotificationsandfeedbackonabandlikedbyauser">handleLike
Sets up notifications and feedback on a band liked by a user</a></li><li><a href="global.html#handleSwipeOpensmodalwhenleftscreenswipedetectedhttps://dev.to/nrymarz/creating-a-tinder-style-swiping-component-with-react-native-part-1-2-h45">handleSwipe
Opens modal when left screen swipe detected
https://dev.to/nrymarz/creating-a-tinder-style-swiping-component-with-react-native-part-1-2-h45</a></li><li><a href="global.html#parsePerformancesTakesinputjsonstring,parsesitintoobjectforuseincomponents">parsePerformances
Takes input json string, parses it into object for use in components</a></li><li><a href="global.html#prepareDeterminesdatasourcesandretrivesdataonappstartup">prepare
Determines data sources and retrives data on app startup</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Tue Feb 01 2022 10:18:45 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
